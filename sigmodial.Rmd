---
title: Biometrical analysis 
author:
- name: Janine Wiebach (janine.wiebach@charite.de)
  affiliation: Institute of Biometry and Clinical Epidemiology
abstract: "This is the abstract text and should describe in some short
  words what is happening in the following document."
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    theme: united
    number_sections: true
    highlight: zenburn
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---

***

```{r init_markdown, echo = FALSE, message=FALSE}
source("init.R")
library("ggpmisc")
library(magrittr)
pacman::p_load(slider)
opts_chunk$set(fig.width=7, fig.height=7, fig.path='img/',
               echo=FALSE, warning=FALSE, message=FALSE,
               cache.path='cache/')
## To use for fills, add
## scale_fill_manual(values=cbbPalette)
## To use for line and point colors, add
## scale_colour_manual(values=cbbPalette)
## kableExtra stuff:
## http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
```

# Section header

## Subsection header

Some text explaining the analysis we are doing

https://davisvaughan.github.io/slider/

```{r functions, results ='hide'}

# function func_lm performs linear regression for 3 consecutive points, starting at point x
  # input : data table with column names [Intensity, Concentration, ID]
  # output: tibble with informations about ID, analyzed point x, n distance and degree, and adjusted R2
func_lm <- function(tbl, x, explanVar = 'Concentration'){
  
  tbl_linear_Range <- list()
  lm_sum <- lm(Intensity ~ get(explanVar), data = tbl[x : (x + 2),]) %>%
    summary()
  
  slope <- coef(lm_sum)[2]
  alpha.rad <- atan(slope)
  
  alpha.deg <- 180*alpha.rad/pi
  
    
  tibble(
    metabolite = tbl$ID[x],
    seqStart = tbl$DilutionPoint[x],
    seqEnd = tbl$DilutionPoint[x + 2],
    slope = lm_sum$coefficient[2], 
    adjr2 = lm_sum$adj.r.squared,
    degree = alpha.deg#,
    #indice = tbl$indice[x]
  )
}

# function func_findLinearRange compares adjusted R2 and slope in degree to defined borders
  # input : data table from func_lm with column names [metabolite, adjR2, degree]; values for adjusted R2 and degree; Number of points necessary to consider a linear range
  # output: tibble with informations about ID, start of linear range, end of linear range, Comment
func_findLinearRange <- function(tbl, adjR2 , degr, points){
  
  adjr2.compare <- (round(tbl$adjr2,2) >= adjR2) & (tbl$degree >= degr)
  
  if (!any(adjr2.compare)) { # adjusted R2 and /or slope are to small 
    tibble(
      ID = unique(tbl$metabolite),
      start = NA,
      end = NA,
      lengthRange = NA,
      Comment = "no linear range"
    )
    
  }else{ # minimum of 3 consecutive points with sufficient adjusted R2 and slope
    
    
    cons <- rle(adjr2.compare) # Compute the lengths of consecutive Trues and Falses
    indic <- which(cons$values == TRUE & cons$lengths >= (points - 2) )
    
    if (length(indic) > 0 ){ # length of consecutive Trues are sufficent
      cons.lengths.cumsum.start = cumsum(cons$lengths) - cons$lengths + 1
      cons.lengths.cumsum.end = cumsum(cons$lengths)
      starts = tbl$seqStart[cons.lengths.cumsum.start[indic]]
      ends = tbl$seqEnd[cons.lengths.cumsum.end[indic]]
      maxlin  <- tbl[which(tbl[ , "degree"] == max(tbl[cons.lengths.cumsum.start[indic]:cons.lengths.cumsum.end[indic], "degree"])), ]
      #newindex = ifelse(indic > 1, indic - 1, 0)
      #starts = cons.lengths.cumsum[newindex] + 1
      #if (0 %in% newindex) starts = c(1,starts)
      
      tibble(
        ID = unique(tbl$metabolite),
        start = starts,
        end = ends,
        lengthRange = ends - starts + 1,
        maxLinearRange = paste(maxlin[, c("seqStart", "seqEnd")], collapse = " : "),
        maxadjR2 = max(tbl[cons.lengths.cumsum.start[indic]:cons.lengths.cumsum.end[indic], "adjr2"]),
        Comment = ""
      )
    } else { # length of consecutive Trues are to small
      
      tibble(
        ID = unique(tbl$metabolite),
        start = NA,
        end = NA,
        lengthRange = NA,
        maxLinearRange = NA,
        maxadjR2 = NA,
        Comment = "no linear range"
      )
    }
    
    
  }
  #})
}

# function func_slider_LinearRange slides through data table of metabolites
 # input: data table with column names [ID, Intensity, Concentration]; Number of points necessary to consider a linear range, boundaries for adjusted R2 value and slope in degree; cooks distance
 # output: 

func_slider_LinearRange <- function(dat, metabolite, points = 5, adjR2 = 0.85, degr = 10, residual = 2){ #, cooksdis = 4
  
  print(metabolite)
  tbl_linear_Range <- list()
  linRange <- data.frame()
  data <- dat %>% filter(ID == metabolite) %>% arrange(Concentration) %>% mutate(DilutionPoint = 1 : nrow(.), Comment = "")
  dataRaw <- data
  
  #outlier
  data <- data[!is.na(data$Intensity), ]
  model <- lm(Intensity ~ Concentration, data)
  data$residuals <- residuals(model)/sd(residuals(model))
  outlier <- which(abs(data$residuals) > residual)
  
  dataRaw <- join(type = "right", data, dataRaw)
  dataRaw$Comment[abs(dataRaw$residuals) > residual] = "Outlier"
  dataRaw$Comment[is.na(dataRaw$Intensity)] = "Missing"
  tbl_linear_Range[[metabolite]][["rawData"]] <- dataRaw
  
  if (any(outlier) | any(is.na(dataRaw$Intensity))) {
    # outlier
    nrOutlier <- length(outlier)  
    linRange <- tibble()
    if (sum(outlier) > 0) data <- dataRaw[-outlier, ]
    # NA
    nrNA <- sum(is.na(dataRaw$Intensity))
    NApos <- which(is.na(dataRaw$Intensity))
    linRange <- tibble()
    data <- data[!is.na(data$Intensity), ]
    
  }
  
  
  
  tbl_lm <- slide(1:(nrow(data) - 2), ~func_lm(tbl = data, .x )) %>% ldply
  
  tbl_linear_Range[[metabolite]][["allLinearRanges"]] <- tbl_lm
  
  
  linRange <- func_findLinearRange(tbl = tbl_lm, adjR2, degr, points )
  linRange <- linRange %>% filter(lengthRange == max(lengthRange))
  
  if (any(linRange$Comment == "")) { # found one linear range, calculate slope and R2 for the whole range
    sum.all <- lm(Intensity ~ Concentration, data = dataRaw[linRange$start:linRange$end,]) %>%
      summary()
    alpha.rad <- atan(
      (dataRaw$Intensity[linRange$end] - dataRaw$Intensity[linRange$start])/
        (dataRaw$Concentration[linRange$end] - dataRaw$Concentration[linRange$start]))
    alpha.deg <- 180*alpha.rad/pi
    
    
    linRange$IntensityStart <- dataRaw$Intensity[linRange$start]
    linRange$IntensityEnd <- dataRaw$Intensity[linRange$end]
    linRange$ConcenstrationStart <- dataRaw$Concentration[linRange$start]
    linRange$ConcenstrationEnd <- dataRaw$Concentration[linRange$end]
    linRange$LinearRangeStart <- linRange$start
    linRange$LinearRangeEnd <- linRange$end
    linRange$adjr2 <- sum.all$adj.r.squared
    linRange$degree <- alpha.deg
    linRange$maxLinearRange <- linRange$maxLinearRange
    linRange$maxadjR2 <- linRange$maxadjR2
    linRange$Comment <- paste0(sum(dataRaw$Comment == "Outlier"), " outliers and ", sum(dataRaw$Comment == "Missing"), " Missings excluded")
    linRange$PositionOfMissings <- ifelse(any(is.na(dataRaw$Intensity)),paste(dataRaw$DilutionPoint[dataRaw$Comment == "Missing"], collapse = "; "), NA)
    linRange$PositionOfOutliers <- ifelse(any(dataRaw$Comment %in% "Outlier"),paste(dataRaw$DilutionPoint[dataRaw$Comment == "Outlier"], collapse = "; "), NA)
    linRange$OutlierInLinearRange <- ifelse(any(dataRaw$Comment %in% "Outlier"),any(between(outlier,linRange$start, linRange$end )),NA)
    linRange$MissingInLinearRange <- ifelse(any(is.na(dataRaw$Intensity)),any(between(NApos,linRange$start, linRange$end )), NA)
    linRange$type <- case_when(
      identical(sort(unique(dataRaw$Comment)), c("","Outlier")) ~ "Outlier",
      identical(sort(unique(dataRaw$Comment)), c("","Missing")) ~ "Missing",
      identical(sort(unique(dataRaw$Comment)), c("","Missing","Outlier")) ~ c("Outlier ,Missing"),
      TRUE ~ "completeCase"
      )
    
    
  } else {# no linear range found
    linRange <- tibble(ID = metabolite)
    
    linRange$IntensityStart <- NA
    linRange$IntensityEnd <- NA
    linRange$ConcenstrationStart <- NA
    linRange$ConcenstrationEnd <- NA
    linRange$LinearRangeStart <- NA
    linRange$LinearRangeEnd <- NA
    linRange$lengthRange <- NA
    linRange$adjr2 <- NA
    maxLinearRange <- NA
    linRange$degree <- NA
    linRange$maxadjR2 <- NA
    linRange$maxLinearRange <- NA
    linRange$Comment <- "no linear range"
    linRange$PositionOfMissings <- ifelse(any(is.na(dataRaw$Intensity)),paste(dataRaw$DilutionPoint[dataRaw$Comment == "Missing"]), "")
    linRange$PositionOfOutliers <- ifelse(any(dataRaw$Comment %in% "Outlier"),paste(dataRaw$DilutionPoint[dataRaw$Comment == "Outlier"]), "")
    linRange$OutlierInLinearRange <- NA
    linRange$MissingInLinearRange <- NA
    linRange$type <- case_when(
      identical(sort(unique(dataRaw$Comment)), c("","Outlier")) ~ "Outlier",
      identical(sort(unique(dataRaw$Comment)), c("","Missing")) ~ "Missing",
      identical(sort(unique(dataRaw$Comment)), c("","Missing","Outlier")) ~ c("Outlier ,Missing"),
      TRUE ~ "completeCase"
      )
    
  }
  
  tbl_linear_Range[[metabolite]][["SummaryLinearRange"]] <- linRange %>% select(ID, IntensityStart, IntensityEnd, ConcenstrationStart, ConcenstrationEnd, LinearRangeStart, LinearRangeEnd, lengthRange, adjr2, degree, maxadjR2,maxLinearRange, Comment, PositionOfOutliers, OutlierInLinearRange, PositionOfMissings, MissingInLinearRange, type)
  
  tbl_linear_Range[[metabolite]]$rawData <- 
    tbl_linear_Range[[metabolite]]$rawData %>% 
    filter(between(
      DilutionPoint, 
      tbl_linear_Range[[metabolite]][["SummaryLinearRange"]]$LinearRangeStart,
      tbl_linear_Range[[metabolite]][["SummaryLinearRange"]]$LinearRangeEnd)) %>%
    mutate(Comment = replace(Comment, row_number() == 1, "start"), Comment = replace(Comment, row_number() == n(), "end")) %>% 
    
    mutate(Comment = ifelse(Comment == "", "linear", Comment)) %>% 
    rbind(tbl_linear_Range[[metabolite]]$rawData %>%
        filter( DilutionPoint < tbl_linear_Range[[metabolite]][["SummaryLinearRange"]]$LinearRangeStart |
            DilutionPoint > tbl_linear_Range[[metabolite]][["SummaryLinearRange"]]$LinearRangeEnd)) %>% 
    arrange(DilutionPoint)
      
  return(tbl_linear_Range)
}

# function histogram output

func_hist_QC_summary <- function(datlist = dataWithrangeAll){
  
  dataPlot <- lapply(1 : length(datlist), function(x) datlist[[x]][[1]][1]) %>% 
    unlist(recursive = F, use.names = F) %>% 
    ldply %>%  
    distinct()
  
  dataPlotsum <- lapply(1 : length(datlist), function(x) datlist[[x]][[1]][3]) %>% 
    unlist(recursive = F, use.names = F) %>% 
    ldply %>%  
    distinct() 

  
  NAdat <- dataPlot$DilutionPoint[dataPlot$Comment == "Missing"] %>% table()
  NANr  <- lapply(1:length(unique(dataPlot$DilutionPoint)), function(x) {
    ifelse(x %in% names(NAdat),yes = NAdat[names(NAdat) == x],no = 0)
  }) %>%  unlist()
  
  Outdat <- dataPlot$DilutionPoint[dataPlot$Comment == "Outlier"] %>% table()
  OutNr  <- lapply(1:length(unique(dataPlot$DilutionPoint)), function(x) {
    ifelse(x %in% names(Outdat),yes = Outdat[names(Outdat) == x],no = 0)
  }) %>%  unlist()
  
  ValidDat <- dataPlot$DilutionPoint[dataPlot$Comment %in% c("linear", "start", "end")] %>% table()
  ValidNr  <- lapply(1:length(unique(dataPlot$DilutionPoint)), function(x) {
    ifelse(x %in% names(ValidDat),yes = ValidDat[names(ValidDat) == x],no = 0)
  }) %>%  unlist()
 
  Compdat <- nrow(dataPlotsum)
  
  
  library(gridExtra)
  
  summary_dat <- tibble(
    "Dilution Point" = 1 : length(unique(dataPlot$DilutionPoint)),
    "Concentration" = unique(dataPlot$Concentration),
    "Nr of NAs" = NANr,
    "Nr of Outliers" = OutNr,
    "Nr of linear points" = ValidNr, 
    "Nr of non valid Points" = rep(Compdat, length(unique(dataPlot$DilutionPoint))) - ValidNr
  )

 g <-  summary_dat %>% 
    gather(key = "Nr", value = "Values", 3:6) %>%
    #mutate(DP = `Dilution Points`) %>% 
  
  ggplot( aes(x = `Dilution Point` , y = Values, fill = Nr )) +
    geom_bar(width = 0.5, position = position_dodge(), stat = "identity") +
    theme_bw() +
    scale_x_continuous(breaks = seq(0, 15, by = 1)) +
    scale_y_continuous(breaks = seq(0, 12, by = 1))
    # annotate(geom = "table",
    #        x = 10,
    #        y = 0,
    #        label = list(summary_dat))
 tbl <- tableGrob(summary_dat, rows=NULL)
 
 grid.arrange(g, tbl,
             ncol = 1,
             as.table = TRUE)
  
}

func_plot_linearRange <- function(datlist, IDs){
  #plot data with linear range
  
  dataPlot <- lapply(1 : length(datlist), function(x) datlist[[x]][[1]][1]) %>% 
    unlist(recursive = F, use.names = F) %>% 
    ldply %>%  
    distinct()
  
  dataPlotsum <- lapply(1 : length(datlist), function(x) datlist[[x]][[1]][3]) %>% 
    unlist(recursive = F, use.names = F) %>% 
    ldply %>%  
    distinct() %>% 
    filter( ID %in% IDs, !is.na(IntensityStart))
  
  data_plot <- dataPlot %>% filter( ID %in% IDs) %>% mutate(color = "black", size = 2)
  
  data_plot_out <- data_plot[!(data_plot$Comment == "Outlier"), ]
  
  data_plot$color[data_plot$Comment %in% c("linear", "start", "end")] <- "green"
  
  data_plot$size[data_plot$Comment %in% c("linear", "start", "end")] <- 4
  
  
  maxRange <- data.frame(t(sapply(dataPlotsum$ID, function(x) cbind(strsplit(dataPlotsum[dataPlotsum$ID == x, c("maxLinearRange")], " : ")[[1]][1],strsplit(dataPlotsum[dataPlotsum$ID == x, c("maxLinearRange")], " : ")[[1]][2]))))
  maxRange <- maxRange %>% mutate(ID = rownames(maxRange), start = as.integer(X1), end = as.integer(X2)) 
  
  
  data_plot <- join(maxRange, data_plot)
  data_maxRange <- data_plot %>% group_by(ID) %>%  filter(DilutionPoint >= start & DilutionPoint <= end )
  
  #data_plot$color[dataWithrange[dataWithrange$ID == meta, c("LinearRangeEnd")]] <- "green"
  #data_plot$size[dataWithrange[dataWithrange$ID == meta, c("LinearRangeEnd")]] <- 4
  # data_plot$color[ 
  #   strsplit(dataPlotsum[dataPlotsum$ID == IDs, c("maxLinearRange")], " : ")[[1]][1] :
  #     strsplit(dataPlotsum[dataPlotsum$ID == IDs, c("maxLinearRange")], " : ")[[1]][2]] <- "purple"
  
  data_plot$color[data_plot$Comment == "Outlier"] <- "red"
  data_plot$line[data_plot$Comment == "Missing"] <- data_plot$Concentration[data_plot$Comment == "Missing"]
  
#reg <- data_plot %>% group_by(ID)  %>% lm(formula = Intensity~poly(Concentration,2))


  data_plot %>% group_by(ID) %>% 
   
  ggplot( aes(Concentration, Intensity)) + 
    geom_point(color = data_plot$color, size = data_plot$size) +
    #geom_point(data = data_maxRange, color = "purple", size = data_maxRange$size) +
    geom_line() + 
     
    # geom_vline(xintercept = data_plot$Concentration[data_plot$Comment == "Missing"], color = "red") +
    facet_wrap(~ID, scales = "free_y") + 
    #geom_vline(xintercept = data_plot$Concentration[data_plot$Comment == "Missing"], color = "red") +
    geom_vline( aes(xintercept = line, color = "red")) +
    geom_smooth(data = data_plot[data_plot$Comment %in% c("linear", "start", "end"),], method = lm) +
   # stat_smooth(data = data_plot[data_plot$Comment %in% c("linear", "start", "end"),] %>%  drop_na(), method = "lm", formula = y ~ poly(x,2), aes(Concentration, reg$fitted.values, col = "Order 1")) +

    #geom_smooth(data = data_plot_out[c(dataPlotsum[dataPlotsum$ID %in% IDs, c("LinearRangeStart")] : dataPlotsum[dataPlotsum$ID %in% IDs, c("LinearRangeEnd")]), ],method = lm,) + 
    theme_bw() #+
    #scale_x_continuous(breaks = seq(0, 3, by = 0.25))
  
}





```
```{r simulating test scenarios}

#tbl_linear_Range %>% ldply()
set.seed(42)

slope_x <- 1.2
slope_x2 <- 2.6

data_complete <- tibble(
  y_raw = c(
    c(1,1,1,1, c(1:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:7 * slope_x2),rep(ceiling(7 * slope_x2),4))
    ),
  Intensity = y_raw + rep(rnorm(15, 0, 0.1),length(y_raw)/15),
  Concentration = rep(1:15, length(y_raw)/15),
  #DilutionPoint = rep(c(1:15),length(y_raw)/15),
  type = c(rep("completeCase", 15*length(y_raw)/15)),
  ID = c(rep(paste0("metabolite CC", 1:(length(y_raw)/15)), each = 15))
)

data_outlier <- tibble(
  y_raw = c(
    c(1,1,1,1, c(1:3 * slope_x,4 * slope_x + 6 ,5:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:2 * slope_x,3 * slope_x + 6 ,4 * slope_x + 6 ,5:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:2 * slope_x,3 * slope_x + 6 ,4 * slope_x + 6 ,5:6 * slope_x,  7 * slope_x - 4),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:3 * slope_x,4 * slope_x - 4 ,5:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:2 * slope_x,3 * slope_x - 4 ,4 * slope_x - 4 ,5:7 * slope_x),rep(ceiling(7 * slope_x),4))

    ),
  Intensity = y_raw + rep(rnorm(15, 0, 0.1),length(y_raw)/15),
  Concentration = rep(1:15, length(y_raw)/15),
  #DilutionPoint = rep(c(1:15),length(y_raw)/15),
  type = c(rep("Outlier", 15*length(y_raw)/15)),
  ID = c(rep(paste0("metabolite out", 1:(length(y_raw)/15)), each = 15))
)

data_NA <- tibble(
  y_raw = c(
    
    c(1,1,1,1, c(1:3 * slope_x, NA ,5:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(1:3 * slope_x, NA, NA ,6:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(1,1,1,1, c(NA, 2:3 * slope_x, NA, NA ,6:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(NA,1,1,1, c(1:3 * slope_x, NA, NA ,6:7 * slope_x),rep(ceiling(7 * slope_x),4)),
    c(NA,NA,1,1, c(1:7 * slope_x),rep(ceiling(7 * slope_x),4))

    ),
  Intensity = y_raw + rep(rnorm(15, 0, 0.1),length(y_raw)/15),
  Concentration = rep(1:15, length(y_raw)/15),
  #DilutionPoint = rep(c(1:15),length(y_raw)/15),
  type = c(rep("NA", 15*length(y_raw)/15)),
  ID = c(rep(paste0("metabolite NA", 1:(length(y_raw)/15)), each = 15))
)


data_c <- rbind(data_complete, data_outlier, data_NA)

# plot data
data_c %>%   
ggplot(aes(Concentration, Intensity)) +
  geom_point() + 
  geom_line() + 
  theme_bw() +
  #scale_y_continuous(limits = c(0, 30), breaks = seq(0, 12, by = 1)) +
  facet_wrap(~ID, scales = "free_y")

rm(metabolite, adjR2, degr, points, dat)
dataWithrangeAll <- lapply(unique(data_c$ID),function(x) {func_slider_LinearRange(dat = data_c, metabolite = x, points = 5, adjR2 = 0.85, degr = 10, residual = 2)})

dataWithrange <- lapply(1 :length(dataWithrangeAll), function(x) dataWithrangeAll[[x]][[1]][3]) %>% unlist(recursive = F, use.names = F) %>% ldply %>%  distinct()
dataWithrange

result <- dataWithrange %>% select("ID", "IntensityStart", "IntensityEnd", "ConcenstrationStart", "ConcenstrationEnd", "lengthRange", Comment, PositionOfOutliers, OutlierInLinearRange, PositionOfMissings, MissingInLinearRange,type)
#plot data with linear range

func_plot_linearRange(datlist = dataWithrangeAll, IDs = dataWithrange$ID)#"metabolite out4")

func_hist_QC_summary(datlist = dataWithrangeAll)
```
Real data

```{r real data data preparation, results ='hide'}

data_tbl_raw <- read.csv(file.path("..", "data/input/20211217_DataMatrixD_Replicates_Updated.csv"), header = T, check.names = F, blank.lines.skip = TRUE)

data_tbl_work1 <- data_tbl_raw %>% 
  mutate(Intensity = as.numeric(Area), Concentration = as.numeric(Dilution), ID = Compound, .keep = "unused" )
  
#RSD <- round(sd(x)/mean(x) * 100, digits = 1)

```

Need input table called "data_tbl_work" with minimal following colnames:
ID, MZ, RT, Concentration, Intensity

```{r label = "211231 data wrangling - adjR2 = 0.85, degree = 10, residual = 2", results ='hide'}

#FEAT_106_05__396_628, FEAT_120_091__335_893, FEAT_167_086__30_772, FEAT_195_003__438_391, FEAT_166_084__336_637, FEAT_147_077__395_524, FEAT_72_0813__341_261, FEAT_144_102__332_147, FEAT_211_144__31_6455, FEAT_546_353__229_961, FEAT_592_502__27_4584 


data_tbl_work <- data_tbl_work1 %>% 
  filter( Replicate == 1, ID %in% c('FEAT_106_05__396_628', 'FEAT_120_091__335_893', 'FEAT_167_086__30_772', 'FEAT_195_003__438_391', 'FEAT_166_084__336_637', 'FEAT_147_077__395_524', 'FEAT_72_0813__341_261', 'FEAT_144_102__332_147', 'FEAT_211_144__31_6455', 'FEAT_546_353__229_961', 'FEAT_592_502__27_4584')) %>% 
  arrange(Concentration)

# plot data
#data_tbl_work$Concentration[data_tbl_work$ID == 'FEAT_167_086__30_772']
reg1 <- data_tbl_work %>%  filter(ID == 'FEAT_120_091__335_893') %>% mutate(log_conc = log(Concentration)) %>%lm(formula = Intensity~poly(log_conc,1))
reg2 <- data_tbl_work %>%  filter(ID == 'FEAT_167_086__30_772') %>% mutate(log_conc = log(Concentration)) %>%lm(formula = Intensity~poly(log_conc,2))

#stat_smooth(method = "lm", formula = y~poly(x,1), aes(Concentration, reg1$fitted.values, col = "Order 1"))



 data_tbl_work %>% 
   drop_na() %>% 
   #filter(ID == 'FEAT_167_086__30_772') %>%  
   mutate(log_conc = log(Concentration)) %>%   
ggplot(aes(log_conc, Intensity)) +
  geom_point() + 
  geom_line() + 
   geom_line(aes(log_conc, Intensity)) +
  theme_bw() +
  geom_smooth(method = lm) +
   #stat_smooth(method = "lm", formula = y~poly(x,2), aes(log_conc, reg2$fitted.values, col = "Order 1")) +
  #scale_y_continuous(limits = c(0, 30), breaks = seq(0, 12, by = 1)) +
  facet_wrap(~ID, scales = "free_y")


 data_tbl_work <- data_tbl_work %>%  mutate(Concentration_raw = Concentration, Concentration = log(Concentration))

dataWithrangeAll <- lapply(unique(data_tbl_work$ID),function(x) {func_slider_LinearRange(dat = data_tbl_work, metabolite = x, points = 5, adjR2 = 0.85, degr = 10, residual = 2)})

dataWithrange <- lapply(1 :length(dataWithrangeAll), function(x) dataWithrangeAll[[x]][[1]][3]) %>% unlist(recursive = F, use.names = F) %>% ldply %>%  distinct()
dataWithrange

#plot data with linear range

h <- !unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]
g <- unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]]

func_plot_linearRange(datlist = dataWithrangeAll[h], IDs = g)

func_hist_QC_summary(datlist = dataWithrangeAll)
```

```{r label = "220110 data wrangling - adjR2 = 0.90, degree = 10, residual = 2", results ='hide'}

#FEAT_106_05__396_628, FEAT_120_091__335_893, FEAT_167_086__30_772, FEAT_195_003__438_391, FEAT_166_084__336_637, FEAT_147_077__395_524, FEAT_72_0813__341_261, FEAT_144_102__332_147, FEAT_211_144__31_6455, FEAT_546_353__229_961, FEAT_592_502__27_4584 


data_tbl_work <- data_tbl_work1 %>% 
  filter( Replicate == 1, ID %in% c('FEAT_106_05__396_628', 'FEAT_120_091__335_893', 'FEAT_167_086__30_772', 'FEAT_195_003__438_391', 'FEAT_166_084__336_637', 'FEAT_147_077__395_524', 'FEAT_72_0813__341_261', 'FEAT_144_102__332_147', 'FEAT_211_144__31_6455', 'FEAT_546_353__229_961', 'FEAT_592_502__27_4584')) %>% 
  arrange(Concentration)

# plot data
# data_tbl_work %>% filter(ID == 'FEAT_120_091__335_893') %>%   
# ggplot(aes(Concentration, Intensity)) +
#   geom_point() + 
#   geom_line() + 
#   theme_bw() +
#   geom_smooth(method = stats::lm(Intensity ~ Concentration, data, weights = 1/Concentration^2))
#   #scale_y_continuous(limits = c(0, 30), breaks = seq(0, 12, by = 1)) +
#   facet_wrap(~ID, scales = "free_y")



dataWithrangeAll <- lapply(unique(data_tbl_work$ID),function(x) {func_slider_LinearRange(dat = data_tbl_work, metabolite = x, points = 5, adjR2 = 0.9, degr = 10, residual = 2)})

dataWithrange <- lapply(1 :length(dataWithrangeAll), function(x) dataWithrangeAll[[x]][[1]][3]) %>% unlist(recursive = F, use.names = F) %>% ldply %>%  distinct()
dataWithrange

#plot data with linear range
h <- !unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]
g <- unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]]



bla <- list()

for(x in 1 : length(g)){
    
 bla[x] <-  func_plot_linearRange(datlist = dataWithrangeAll[h], IDs = g[x])
    
  }
print(
 bla[1], bla[2]
)

grid.arrange(
  func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][1]),
    func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][2]),
      func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][3]),
        func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][4]),
          func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][5]),
            func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][6]),
              func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][7]),
                func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][8]),
                  func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][9]),
                    func_plot_linearRange(datlist = dataWithrangeAll, IDs = unique(data_tbl_work$ID)[!unique(data_tbl_work$ID) %in% dataWithrange$ID[dataWithrange$Comment == "no linear range"]][10]),
                      ncol = 4
)  



func_hist_QC_summary(datlist = dataWithrangeAll)
```


```{r triplicates}

data_tbl_work <- data_tbl_work1 %>% 
  filter(ID %in% c('FEAT_106_05__396_628', 'FEAT_120_091__335_893', 'FEAT_167_086__30_772', 'FEAT_195_003__438_391', 'FEAT_166_084__336_637', 'FEAT_147_077__395_524', 'FEAT_72_0813__341_261', 'FEAT_144_102__332_147', 'FEAT_211_144__31_6455', 'FEAT_546_353__229_961', 'FEAT_592_502__27_4584')) %>% 
  #mutate(ID = paste( ID, Replicate,sep = "_" )) %>% 
  arrange(Concentration)

dataWithrangeAll <- lapply(unique(data_tbl_work$ID),function(x) {func_slider_LinearRange(dat = data_tbl_work, metabolite = x, points = 5, adjR2 = 0.85, degr = 10, residual = 2)})

dataWithrange <- lapply(1 :length(dataWithrangeAll), function(x) dataWithrangeAll[[x]][[1]][3]) %>% unlist(recursive = F, use.names = F) %>% ldply %>%  distinct()
dataWithrange


data_tbl_work %>% filter(ID %in% c('FEAT_106_05__396_628')) %>% 
  ggplot(aes( x = Concentration, y = Intensity, color = Replicate)) +
  geom_point() +
  


RSD <- data_tbl_work %>% 
  group_by(ID, Concentration) %>% 
  summarize(mean = abs(mean(Intensity, na.rm = T)), sd = sd(Intensity, na.rm = T), RSD = round(100 * sd(Intensity, na.rm = T)/abs(mean(Intensity, na.rm = T)), digits = 1))

RSD <- RSD %>% 
  mutate(RSDsum = case_when(
    RSD < 15 ~ '< 15 %',
    RSD < 20 ~ '< 20 %',
    RSD < 25 ~ '< 25 %',
    RSD < 30 ~ '< 30 %',
    TRUE ~  '> 30 %'
  ))

# barplot
RSD %>% group_by(Concentration, RSDsum) %>% summarise(n = n()) %>% 
  ggplot( aes(x = as.factor(Concentration), y = n,  fill = RSDsum)) + 
  geom_bar(width = 0.5, position = position_dodge(), stat = "identity") +
  scale_y_continuous(breaks = seq(0, 12, by = 1))


# boxplot
RSD %>% 
  ggplot( aes(x = as.factor(Concentration), y = RSD)) +
  geom_boxplot() +
  geom_hline(yintercept = 30)


ggplot( aes(x = `Dilution Point` , y = Values, fill = Nr )) +
    geom_bar(width = 0.5, position = position_dodge(), stat = "identity") +
    theme_bw() +
    scale_x_continuous(breaks = seq(0, 15, by = 1)) +
    scale_y_continuous(breaks = seq(0, 12, by = 1))
    # 

RSD_average <- data_tbl_work %>% 
  group_by(Concentration) %>% 
  summarize(mean = abs(mean(Intensity, na.rm = T)), sd = sd(Intensity, na.rm = T), RSD = round(100 * sd(Intensity, na.rm = T)/abs(mean(Intensity, na.rm = T)), digits = 1))



```

```{r label = "data for polynomial approach"}

data_tbl_raw <- read.csv(file.path("..", "data/input/20211217_DataMatrixD_Replicates_Updated.csv"), header = T, check.names = F, blank.lines.skip = TRUE)

data_tbl_work1 <- data_tbl_raw %>% 
  mutate(Intensity = as.numeric(Area), Concentration = as.numeric(Dilution), ID = Compound, .keep = "unused" )

name = 'FEAT_546_353__229_961'

data_tbl_work <- data_tbl_work1 %>% 
  filter( Replicate == 1, ID %in% c('FEAT_106_05__396_628', 'FEAT_120_091__335_893', 'FEAT_167_086__30_772', 'FEAT_195_003__438_391', 'FEAT_166_084__336_637', 'FEAT_147_077__395_524', 'FEAT_72_0813__341_261', 'FEAT_144_102__332_147', 'FEAT_211_144__31_6455', 'FEAT_546_353__229_961', 'FEAT_592_502__27_4584')) %>% 
  arrange(Concentration)

dat <- data_tbl_work %>% 
          drop_na() %>% 
         #filter(ID == 'FEAT_546_353__229_961') %>% 
         filter(ID == name) %>%
         #filter(ID == 'FEAT_592_502__27_4584') %>%
         #mutate(log_conc = log(Concentration))
         mutate(Concentration_raw = Concentration, Concentration = log(Concentration)) %>% 
  mutate(DilutionPoint = 1 : nrow(.), Comment = "", Intensity_raw = Intensity, Intensity = Intensity/max(Intensity)*100, DP = DilutionPoint-mean(DilutionPoint))

plot(y = dat$Intensity,x = dat$DP)

#position from which Intensity is not anymore unqihely related to concentration

```


trim ends, remove all points which have a higher intensity than last point or a lower intensity than first point
```{r trimming}
trimCurve <- function(dat){
  
  if(last(dat$Intensity) != max(dat$Intensity)){  
    dat.reduced.max <- dat %>% 
      filter(Intensity >= last(Intensity)) %>% 
      mutate(Comment = "invalid") %>% 
      select(DilutionPoint, Comment)
  } else {dat.reduced.max <- dat %>% select(DilutionPoint, Comment)}
    
  if(dat$Intensity[1] != min(dat$Intensity)){
    dat.reduced.min <- dat %>% 
      filter(Intensity <= Intensity[1]) %>% 
      mutate(Comment = "invalid") %>% 
      select(DilutionPoint, Comment)
  } else {dat.reduced.min <- dat %>% select(DilutionPoint, Comment)}
    
    dat.combined <- join_all(list(dat.reduced.max,dat.reduced.min, dat %>% select(-Comment)), type = "right", by = c("DilutionPoint"))
    
    
}

trim.dat <- trimCurve(dat)

    valid.dat <- trim.dat %>% filter(is.na(Comment))
    cons <- rle(diff(valid.dat$DilutionPoint) == 1)
    
    any(cons$lengths >= 5 & cons$values == TRUE)




```
Remove Endpoints, which are obviosly not in the linear range.
1.) calculate slope
```{r slope}
slope <- function(x, y, index ){180 * atan((y[index] - (y[index - 1]))/(x[index] - (x[index - 1])))/pi}


slopes <- slide(2 : nrow(dat), ~ slope(y = dat$Intensity, x = dat$DP, index = .x)) %>% ldply %>% mutate(Nr = 2:nrow(dat), comment = "")

# remove negative slopes at the ends
trimSlope <- function(dat){
  
  dat <- dat %>% rbind(c(0,1,""), .)
  datnew <- dat
  
  while(last(dat$V1) < 0 ){ # end
    
    if(last(dat$V1) >= 0){
      
      dat$comment[nrow(dat)] = "in"
      datnew$comment[nrow(dat)] <- dat$comment[nrow(dat)]
      
    } else {
      dat$comment[nrow(dat)] = "out"
      datnew$comment[nrow(dat)] <- dat$comment[nrow(dat)]
      dat <- dat[-nrow(dat),]
    }
  }
  
  dat <- datnew
  
  while(dat$V1[2] < 0 ){ #start
    if(dat$V1[2] >= 0){
      
      dat$comment[1] = "in"
      datnew$comment[dat$Nr[1]] <- dat$comment[1]
      
    } else {
      dat$comment[1] = "out"
      datnew$comment[dat$Nr[1]] <- dat$comment[1]
      dat <- dat[-1,]
    }  
    
    
  }
  return(datnew)
}

trimmed <- trimSlope(slopes)
dat.trim <- dat %>% filter(trimmed$comment != "out")

plot(y = dat.trim$Intensity,x = dat.trim$DP)

  tbl_lm <- slide(1:(nrow(dat.trim) - 2), ~func_lm(tbl = dat.trim, .x , explanVar = "DP")) %>% ldply


```
```{r categorize}

#dat <- data_c %>%  filter(ID %in% "metabolite CC1") %>% mutate(DilutionPoint = 1 : nrow(.), Comment = "")
 

dat <- data.frame(ID = rep("test",10),Intensity = c( 1, 2, 3, 4, 4.5, 4.5 , 4.5, 4.3,4.5,4.3), Concentration = c(0 : 9)) %>% mutate(DilutionPoint = 1 : nrow(.), DP = DilutionPoint-mean(DilutionPoint), Comment = "")#, Intensity = Intensity/max(Intensity)*100)

plot(y = dat$Intensity,x = dat$Concentration)#dat$Concentration)

  tbl_lm <- slide(1:(nrow(dat) - 2), ~func_lm(tbl = dat, .x , explanVar = "DP")) %>% ldply
  
  dat$Intensity %>% detect_index(~ . >= last(dat$Intensity))


library(drc)
model.sigmoid <- drm(Intensity ~ DP, fct = L.3(), data = dat.trim)
model.linear <- lm(Intensity ~ DP, data = dat.trim)
model.quadratic <- lm(Intensity ~ poly(DP,2,raw=TRUE), data = dat.trim)

lines(y = predict(model.sigmoid), x = dat.trim$DP,col = "green")
lines(y = predict(model.linear), x = dat.trim$DP, col = "red")
#lines(y = predict(model.quadratic), x = dat.trim$DP, col = "blue")
# correlation
cor(dat.trim$Intensity, predict(model.sigmoid))
cor(dat.trim$Intensity, predict(model.linear))
cor(dat.trim$Intensity, predict(model.quadratic))
# SSE (Sum of Squares Error)
sum((fitted(model.sigmoid) - dat.trim$Intensity)^2)
sum((fitted(model.linear) - dat.trim$Intensity)^2)
sum((fitted(model.quadratic) - dat.trim$Intensity)^2)

# use package sicegar to categorize signals

library(sicegar)

dat.red <- dat %>%   mutate(time = log(Concentration) + 3, intensity = Intensity) %>% select(time, intensity)

dat.norm <- normalizeData(dataInput = dat.red)

sigmoidalModel <- multipleFitFunction(dataInput = dat.norm,
                                          model = "sigmoidal",
                                          n_runs_min = 20,
                                          n_runs_max = 500,
                                          showDetails = FALSE)

doubleSigmoidalModel <- multipleFitFunction(dataInput = dat.norm,
                                                model = "doublesigmoidal",
                                                n_runs_min = 20,
                                                n_runs_max = 500,
                                                showDetails = FALSE)
# Calculate additional parameters
sigmoidalModel <- parameterCalculation(sigmoidalModel)

# Calculate additional parameters
doubleSigmoidalModel <- parameterCalculation(doubleSigmoidalModel)

decisionProcess <- categorize(threshold_minimum_for_intensity_maximum = 0.3,
                                      threshold_intensity_range = 0.1,
                                      threshold_t0_max_int = 0.05*10000000,
                                      parameterVectorSigmoidal = sigmoidalModel,
                                      parameterVectorDoubleSigmoidal = doubleSigmoidalModel)
                                      
fig01 <- sicegar::figureModelCurves(dataInput = dat.norm,
                                  doubleSigmoidalFitVector = doubleSigmoidalModel,
                                  showParameterRelatedLines = TRUE)
print(fig01)

fig02 <- sicegar::figureModelCurves(dataInput = dat.norm,
                                  sigmoidalFitVector = sigmoidalModel,
                                  showParameterRelatedLines = TRUE)
print(fig02)

```
```{r find linear range}
# fit with polynomial function
a <- lm(data = dat, formula = Intensity ~ poly(log_conc,1))
b <- lm(data = dat, formula = Intensity ~ poly(log_conc,2))
c <- lm(data = dat, formula = Intensity ~ poly(log_conc,3))
d <- lm(data = dat, formula = Intensity ~ poly(log_conc,4))

# calculate correaltion
cor.poly <- c(
  cor(dat$Intensity, predict(a)),
  cor(dat$Intensity, predict(b)),
  cor(dat$Intensity, predict(c)),
  cor(dat$Intensity, predict(d))
)

cor.max <-  which(cor.poly == max(cor.poly))
cor.max <- get(chartr("1234", "abcd",cor.max))
#e <- glm(family = "poisson", data = dat, formula = Intensity ~ log_conc)

fitted(cor.max)
#sum((fitted(b) - dat.red$time)^2)

# plot raw data
plot(dat$Intensity ~ dat$Concentration, pch = 19)
title(name)

# plot log transformed data
plot(dat$Intensity ~ dat$log_conc, pch = 19)
title(name)

# plot fitted curve
lines(y = fitted(cor.max), x = dat$log_conc, col = "green")

# calculate halfmax intensity of fitted curve
int50 <- DescTools::Closest(x = dat$Intensity,a = max(fitted(cor.max))/2, which = TRUE)

lines(y = fitted(cor.max)[int50], x = dat$log_conc[int50], col = "red", type = "p", cex = 2, pch = 19)

#create linear regression line going through int50
linear.range <- lm(fitted(cor.max)[(int50 - 1) : (int50 + 1)] ~ dat$log_conc[(int50 - 1) : (int50 + 1)])
abline.intensity <- coef(linear.range)[1] + coef(linear.range)[2]*dat$log_conc

abline(linear.range, col = "red")
#abline(h = 0, lty = "dashed")
#concentrationAt0 <- (0 - coef(linear.range)[1] )/ coef(linear.range)[2]

# compare regression line with fitted curve, calculate normalized differences, determine linear range start and end

ndx <- which(abs((dat$Intensity - abline.intensity) /max(abs(dat$Intensity - abline.intensity))) < 0.1)


abline(v = dat$log_conc[ndx[1]], lty = "dashed")
abline(v = dat$log_conc[tail(ndx,1)], lty = "dashed")




# slopes <- function(x, dat = dat){
# (fitted(c)[x] - fitted(c)[x+1]) /(dat$log_con[x] - dat$log_con[x + 1])
# 
# }
# 
# slopes(x = 1)
# 
# lines(y = int50, x = dat$log_conc[dat$Intensity == int50], col = "purple", type = "p", cex = 4)



```

other possibilities: 

library(dr4pl)

a <- dr4pl(dose = sample_data_1$Dose,
             response = sample_data_1$Response,
             method.init = "logistic")
  d = plot(a)
  d + geom_hline(yintercept = a$parameters[1]) + geom_hline(yintercept = a$parameters[4])
  
  
  dat <- data_tbl_work %>% 
          drop_na() %>% 
         filter(ID == 'FEAT_546_353__229_961') %>%  
         mutate(log_conc = log(Concentration))
  
  
  a <- dr4pl(dose = dat$Concentration,
             response = dat$Intensity,
             method.init = "logistic")
  d = plot(a)
  d + geom_hline(yintercept = a$parameters[1]) + geom_hline(yintercept = a$parameters[4])
  
  
  
  

  ##Use default or Assign method.init = "Mead" to use Mead's method of estimation.
  # Use method.robust to select desired loss function
  # formula method
  b <- dr4pl(formula = Response~Dose,
             data = sample_data_4,
             method.init = "Mead",
             method.robust = "Tukey" )
  plot(b)

  #data.frame method
  c <- dr4pl(data = sample_data_10,
             dose = Dose,
             response = Response)
  plot(c)

  ##compatable with ggplot
  library(ggplot2) #load ggplot2
  c <- dr4pl(Response~Dose,
             data = drc_error_2,
             method.optim = "CG",
             trend = "decreasing" )
  d <- plot(c, x.breaks = c(.00135, .0135, .135, 1.35, 13.5))
  d + theme_grey()


library(drda)

fit = drda(data = dat, formula = Intensity ~ Concentration, is_log = F, mean_function = "logistic4")
fit2 = drda(data = dat, formula = Intensity ~ Concentration, is_log = F, mean_function = "logistic2")



summary(fit)
#fit$
plot(fit2)


library(drc)

fit <- drm(Intensity ~ Concentration, data = dat, fct =LL.4())

summary(fit)

plot(fit)
plot(fit, level = c(1,2), add = T,col = TRUE)





dat <- data_c %>% filter(ID == "metabolite CC1") %>% mutate(log_conc = Concentration)



sigmoid = function(x) {
   1 / (1 + exp(-x))
}



#sse <- sum((fitted(a) - dat.red$time)^2)



 
 ###
#slope in degree
# Satz des Pythagoras:  tan(alpha) = Gegenkathete / Ankathete  -> alpha = arctan((y3-y1)/(x3-x1))

##########

 

***

# Session Info 

This is the session information. This might be interesting later on if
the project should be reanimated after a while. In addition the
information might be interesting if other are looking at this project.

```{r, echo = FALSE, comment ='', results='markup'}
sessionInfo()
```

